//===============================================================================
// Microsoft patterns & practices
// Smart Client Software Factory
//===============================================================================
// Copyright  Microsoft Corporation.  All rights reserved.
// THIS CODE AND INFORMATION IS PROVIDED "AS IS" WITHOUT WARRANTY
// OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT
// LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
// FITNESS FOR A PARTICULAR PURPOSE.
//===============================================================================
// The example companies, organizations, products, domain names,
// e-mail addresses, logos, people, places, and events depicted
// herein are fictitious.  No association with any real company,
// organization, product, domain name, email address, logo, person,
// places, or events is intended or should be inferred.
//===============================================================================

//----------------------------------------------------------------------------------------
// patterns & practices - Smart Client Software Factory - Guidance Package
//
// This file was generated by the "Add CAB Module" recipe.
//
// This class contains placeholder methods for the common module initialization 
// tasks, such as adding services, or user-interface element
//
// For more information see: 
// // ms-help://MS.VSCC.v80/MS.VSIPCC.v80/ms.scsf.2006jun/SCSF/html/03-270-Creating%20a%20Module.htm
//
// Latest version of this Guidance Package: http://go.microsoft.com/fwlink/?LinkId=62182
//----------------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Text;
using System.Windows;
using System.Windows.Media;
using System.Xml;
using dvSlave;
using Imi.Framework.UX;
using Imi.Framework.UX.Identity;
using Imi.SupplyChain.UX.Infrastructure;
using Imi.SupplyChain.UX.Infrastructure.Services;
using Imi.SupplyChain.UX.Modules.OrderManagement.Configuration;
using Imi.SupplyChain.UX.Modules.OrderManagement.Services;
using Imi.SupplyChain.UX.Modules.OrderManagement.Views;
using Imi.SupplyChain.UX.Modules.OrderManagement.Views.Constants;
using Microsoft.Practices.CompositeUI;
using Microsoft.Practices.CompositeUI.EventBroker;
using Microsoft.Practices.CompositeUI.SmartParts;

namespace Imi.SupplyChain.UX.Modules.OrderManagement
{
    public class ModuleController : WorkItemController, IShellModule
    {
        public const string ModuleId = "OrderManagement";

        IList<IDialogView> OpenTabs;
        Boolean isWindowCloseRequested = false;
        OMSConfigurationSection configSection;
        IDialogView workbenchParentView;
        private IAOMWebServiceWrapper omsWebServiceWrapper;
        private IOMSSessionContext omsSessionContext;
        private static int programStartSequence = 0;

        //Dictionaries to keep track of the module that chontains the OMS program. [Dashboard compliance]
        private Dictionary<dvStart, object> dvStartContainingModuleDic = new Dictionary<dvStart, object>();
        private Dictionary<inUC, object> inUCContainingModuleDic = new Dictionary<inUC, object>();
        private Dictionary<string, string> startParametersDictionary = new Dictionary<string, string>();

        [ServiceDependency]
        public IShellInteractionService ShellInteractionService
        {
            get;
            set;
        }

        [ServiceDependency]
        public IUserSessionService UserSessionService { get; set; }

        public override void Run()
        {
            omsSessionContext = WorkItem.Services.AddNew<OMSSessionContext, IOMSSessionContext>();
            omsWebServiceWrapper = WorkItem.Services.AddNew<AOMWebServiceWrapper, IAOMWebServiceWrapper>();

            OpenTabs = new List<IDialogView>();
            configSection = ConfigurationManager.GetSection(OMSConfigurationSection.SectionKey) as OMSConfigurationSection;
            OMSProgramUtils.SetHostPort(configSection, UserSessionService);
            OMSProgramUtils.addIE10RegistryKey();

            ShellInteractionService.SmartPartClosing += SmartPartClosingEventHandler;
            Application.Current.MainWindow.Closing += new System.ComponentModel.CancelEventHandler(MainWindow_Closing);
            ShellInteractionService.HyperlinkExecuted += HyperlinkExecutedEventHandler;
            ShellInteractionService.HelpRequested += HelpRequestedEventHandler;
        }


        [EventSubscription(EventTopicNames.ShowChooseUserDialog)]
        public void OnShowChooseUserDialog(object sender, EventArgs args)
        {
            IChooseUserView chooseUserView = WorkItem.SmartParts.AddNew<ChooseUserView>();
            IList<string> list = omsWebServiceWrapper.GetUsers();
            chooseUserView.PresentData(createComboBoxData(list));

            if (list.Count > 1)
            {
                if (chooseUserView.ShowDialog() == true)
                {
                    string userId = chooseUserView.SelectedUserId;
                    setOMSUserContext(userId);
                }
            }
            else if (list.Count == 1)
            {
                setOMSUserContext(list[0]);
            }

            if (String.IsNullOrEmpty(omsSessionContext.OMSLogicalUserId))
            {
                // error handling; no logical OMS user set
                throw new Exception("Error: no context set for OMS system");
            }

            // get OMS user gui config for choosen user
            omsWebServiceWrapper.GetGuiConfiguration();
            SetProgramContextFrameInfo();
        }

        [EventSubscription(EventTopicNames.ShowOMSUserInfoPopup)]
        public void OnShowOMSContextPopup(object sender, EventArgs args)
        {
            IUserInfoView contextPopup = WorkItem.SmartParts.AddNew<UserInfoView>();
            contextPopup.PresentData(omsSessionContext);

            if (contextPopup.ShowDialog() == true)
            {
            }
        }

        [EventSubscription(EventTopicNames.StartWebApp)]
        public void OnShowWebView(object sender, MenuItemExecutedEventArgs args)
        {
            StartWebView(args.MenuItem.Parameters, args.MenuItem.Caption, null);
        }

        private void HyperlinkExecutedEventHandler(object sender, HyperlinkExecutedEventArgs e)
        {
            //Set user data. [Dashboard compliance]
            if (omsSessionContext.ClientProgram == null)
            {
                EventTopic userSettingsTopic = WorkItem.EventTopics.Get(Imi.SupplyChain.UX.Modules.OrderManagement.Views.Constants.EventTopicNames.ShowChooseUserDialog);
                userSettingsTopic.Fire(this, new EventArgs(), WorkItem, PublicationScope.Global);
            }

            // A program is called from an application outside the container
            string programName = e.Hyperlink.Data.ContainsKey("DialogId") ? e.Hyperlink.Data["DialogId"] : null;
            string programArgument = e.Hyperlink.Data.ContainsKey("Parameters") ? e.Hyperlink.Data["Parameters"] : null;
            string programType = e.Hyperlink.Data.ContainsKey("ProgramType") ? e.Hyperlink.Data["ProgramType"] : null;
            string programDescription = e.Hyperlink.Data.ContainsKey("DialogDescription") ? e.Hyperlink.Data["DialogDescription"] : null;
            if (programType == null || programType.Equals("trim"))
            {
                StartTrimProgram(programName, programArgument);
            }
            else if (programType.Equals("anywhere"))
            {
                StartWebView(programName, programDescription, programArgument);
            }
        }

        private void StartWebView(string programName, string programDescription, string programArgument)
        {
            string oneTimePassword = omsWebServiceWrapper.GetAWSOneTimePassword(omsSessionContext.OMSLogicalUserId);
            IWebView webView = WorkItem.SmartParts.AddNew<WebView>();
            webView.menuId = programName;
            webView.menuDescription = programDescription;
            webView.oneTimePassword = oneTimePassword;
            webView.logicalUser = omsSessionContext.OMSLogicalUserId;
            webView.loginId = omsSessionContext.DomainUser;
            SmartPartInfo webSmartPartInfo = new SmartPartInfo();
            webSmartPartInfo.Title = programName;
            webSmartPartInfo.Description = programDescription;
            ShellInteractionService.Show(webView, webSmartPartInfo);
        }

        [EventSubscription(EventTopicNames.StartOMSProgramWithData)]
        public void OnClickFavoriteSearch(object sender, MenuItemExecutedEventArgs args)
        {
            string programName = args.MenuItem.Id;
            string parameters = args.MenuItem.Parameters;
            StartTrimProgram(programName, parameters);
        }

        private void StartTrimProgram(string programName, string programArgument)
        {
            if (programArgument != null)
            {
                programArgument = System.Web.HttpUtility.HtmlEncode(programArgument);
            }

            startParametersDictionary.Add(programName, programArgument);
            dvStart TrimStartClient = new dvStart();

            //Add entry for module that contains the Trimcomponent. [Dashboard compliance]
            dvStartContainingModuleDic.Add(TrimStartClient, ShellInteractionService.ActiveModule);

            TrimStartClient.evCreate += new EventHandler<dvEventArgs>(InitializeTrimWindowHandler);
            try
            {
                string startTrimProgramXml = createStartOmsProgramXml(programName, programArgument);
                TrimStartClient.newWindow(startTrimProgramXml);
            }
            catch (SecurityTokenExpiredException ex)
            { }
        }

        private void HelpRequestedEventHandler(object sender, HelpRequestedEventArgs e)
        {
            if (string.IsNullOrEmpty(omsSessionContext.HelpUrl))
            {
                e.Cancel = true;
            }
            else
            {
                Imi.SupplyChain.UX.Views.IExplorerView _helpView1 = WorkItem.SmartParts.AddNew<Imi.SupplyChain.UX.Views.ExplorerView>();
                SmartPartInfo _helpInfo1 = new SmartPartInfo();
                _helpInfo1.Title = Resources.HelpTabTitle;
                Uri helpUri = new Uri(omsSessionContext.HelpUrl);
                _helpView1.SetUrl(_helpInfo1.Title, helpUri.AbsoluteUri);
                ShellInteractionService.Show(_helpView1, _helpInfo1);
            }
        }

        private OMSUsersComboBoxData createComboBoxData(IList<string> userIdList)
        {
            OMSUsersComboBoxData cbData = new OMSUsersComboBoxData();
            IList<OMSUser> omsUserlist = new List<OMSUser>();
            foreach (string userId in userIdList)
            {
                OMSLogicalUserData userData = omsSessionContext.OMSUsersList[userId];
                OMSUser omsUser = new OMSUser();
                omsUser.UserId = userId;
                omsUser.LegalEntity = userData.legalEntity.ToString();
                omsUser.WarehouseId = userData.warehouseNumber.ToString();
                omsUserlist.Add(omsUser);
            }
            OMSUserCollection uColl = new OMSUserCollection(omsUserlist);
            cbData.OMSUsers = uColl;
            return cbData;
        }

        private void setOMSUserContext(string userId)
        {
            OMSLogicalUserData userData = omsSessionContext.OMSUsersList[userId];
            omsSessionContext.LegalEntity = userData.legalEntity;
            omsSessionContext.OrgUnit = userData.orgUnit;
            omsSessionContext.OMSLogicalUserId = userData.omsLogicalUserId;
            omsSessionContext.OMSLoginUserId = userData.omsLoginUserId;
            omsSessionContext.UserName = userData.userName;
            omsSessionContext.WarehouseNumber = userData.warehouseNumber;
            omsSessionContext.EmployNumber = userData.employNumber;
        }

        [EventSubscription(Imi.SupplyChain.UX.Modules.OrderManagement.Views.Constants.EventTopicNames.StartOMSProgram)]
        public void OnShowOmsProgram(object sender, MenuItemExecutedEventArgs args)
        {
            // user has clicked on a program menu item ....
            string programName = args.MenuItem.Parameters;
            dvStart TrimStartClient = new dvStart();

            //Add entry for module that contains the Trimcomponent. [Dashboard compliance]
            dvStartContainingModuleDic.Add(TrimStartClient, ShellInteractionService.ActiveModule);

            TrimStartClient.evCreate += new EventHandler<dvEventArgs>(InitializeTrimWindowHandler);
            try
            {
                string startTrimProgramXml = createStartOmsProgramXml(programName, null);
                TrimStartClient.newWindow(startTrimProgramXml);
            }
            catch (SecurityTokenExpiredException ex)
            { }
        }

        private void InitializeTrimWindowHandler(object sender, dvEventArgs e)
        {
            // backend is about to start a new program, define event to use to open program in container
            inUC TrimControl = e.Content;

            //Move module referens for Trim component for the newley created instance. [Dashboard compliance]
            if (dvStartContainingModuleDic.ContainsKey((dvStart)sender))
            {
                inUCContainingModuleDic.Add(TrimControl, dvStartContainingModuleDic[(dvStart)sender]);
                dvStartContainingModuleDic.Remove((dvStart)sender);
            }

            TrimControl.evOpenWin += new EventHandler<dvEventArgs>(OpenTrimWindowHandler);
        }

        private void InitializeWorkbenchWindowHandler(object sender, dvEventArgs e)
        {
            // backend is about to start a new child program to a workbench
            inUC TrimControl = e.Content;
            TrimControl.evOpenWin += new EventHandler<dvEventArgs>(OpenTrimWindowHandler);
        }


        private void OpenTrimWindowHandler(object sender, dvEventArgs e)
        {
            // backend has created a new UserControl, show it as a new tab or new window or  ...
            inUC TrimControl = e.Content;
            IDialogView OmsControl = WorkItem.SmartParts.AddNew<DialogView>();
            OmsControl.Id = programStartSequence++;

            //Save the containing module for the OmsControl to use when it is closing. [Dashboard compliance]
            object containingModule = null;
            if (inUCContainingModuleDic.ContainsKey((inUC)sender))
            {
                containingModule = inUCContainingModuleDic[(inUC)sender];
                inUCContainingModuleDic.Remove((inUC)sender);
            }

            //System.Diagnostics.Debug.WriteLine("Opening new trim Dialog: " + OmsControl.Id);
            OmsControl.Show(TrimControl);
            SmartPartInfo spInfo = null;

            switch (e.Type)
            {
                case dvWinType.Main:
                    ShellInteractionService.Show(OmsControl);
                    OpenTabs.Add(OmsControl);
                    break;

                case dvWinType.Modal:
                    // currently not used!
                    break;

                case dvWinType.Float:
                    // currently not used!
                    break;
            }

            TrimControl.evCloseWin += (s, args) =>
            {
                // backend confirms it is OK to close a program
                OmsControl.OKToClose();
                //System.Diagnostics.Debug.WriteLine("About to close Dialog " + OmsControl.Id);

                if (OmsControl.ParentProgram != null)
                {
                    IDialogView parent = OmsControl.ParentProgram;
                    parent.RemoveChildProgram(OmsControl);
                    OmsControl.ParentProgram = null;
                }

                switch (e.Type)
                {
                    case dvWinType.Main:

                        //Check containing module and use it´s ShellInteractionService to close the OmsControl. [Dashboard compliance]
                        if (containingModule != null)
                        {
                            if (containingModule.GetType().GetProperty("ShellInteractionService") != null)
                            {
                                ((IShellInteractionService)containingModule.GetType().GetProperty("ShellInteractionService").GetValue(containingModule, null)).Close(OmsControl);
                            }
                        }
                        else
                        {
                            ShellInteractionService.Close(OmsControl);
                        }

                        WorkItem.SmartParts.Remove(OmsControl);
                        OpenTabs.Remove(OmsControl);
                        if (OpenTabs.Count == 0 && isWindowCloseRequested)
                        {
                            // user has requested to close the window and no open programs remain
                            Application.Current.MainWindow.Close();
                        }
                        break;

                    case dvWinType.Modal:
                        // currently not used
                        break;

                    case dvWinType.Float:
                        // currently not used
                        break;
                }
            };

            TrimControl.evTitleWin += (s, args) =>
            {
                // set title and description (as tooltip on tab)
                string programInfo = (string)((FrameworkElement)TrimControl).Tag;
                char[] c = { ' ' };
                string[] programInfoSplit = programInfo.Split(c);
                string title = programInfoSplit[0];
                int titleLength = title.Length;
                if (OmsControl.ParentProgram != null)
                {
                    string parentTitle = OmsControl.ParentProgram.ProgramName;
                    title = parentTitle + " > " + title;
                }
                OmsControl.ProgramName = title;
                string description = null;
                if (programInfo.Length > titleLength)
                {
                    description = programInfo.Substring(titleLength + 1).Trim();
                    OmsControl.ProgramDescription = description;
                }

                if (startParametersDictionary.ContainsKey(title))
                {
                    string startParams = startParametersDictionary[title];
                    OmsControl.StartParameters = startParams;
                    startParametersDictionary.Remove(title);
                }

                //System.Diagnostics.Debug.WriteLine("Setting title on Dialog " + OmsControl.Id + " to " + title);

                switch (e.Type)
                {
                    case dvWinType.Main:
                        spInfo = new SmartPartInfo();
                        spInfo.Title = title;
                        spInfo.Description = description;
                        ShellInteractionService.Show(OmsControl, spInfo);

                        break;

                    case dvWinType.Float:
                        // currently not used
                        break;
                }
            };

            if (workbenchParentView != null)
            {
                // backend is about to start a new sub program to a workbench
                workbenchParentView.AddChildProgram(OmsControl);
                OmsControl.ParentProgram = workbenchParentView;
                workbenchParentView = null;
            }

            TrimControl.evSendString += (s, args) =>
            {
                // event received when starting and stopping workbench programs
                // or when the actions menu is to be updated
                string receivedStr = (string)((FrameworkElement)TrimControl).Tag;
                receivedStr = System.Web.HttpUtility.HtmlDecode(receivedStr);
                if (receivedStr.StartsWith("startProgram"))
                {
                    OmsControl.IsWorkbenchParent = true;
                    workbenchParentView = OmsControl;
                    dvStart TrimStartClient = new dvStart();
                    TrimStartClient.evCreate += new EventHandler<dvEventArgs>(InitializeWorkbenchWindowHandler);
                    try
                    {
                        string startWorkbenchProgXML = createStartWorkbenchProgramXml(receivedStr);
                        TrimStartClient.newWindow(startWorkbenchProgXML);
                    }
                    catch (SecurityTokenExpiredException ex)
                    { }
                }
                else if (receivedStr.StartsWith("stopProgram"))
                {
                    foreach (IDialogView childProgram in OmsControl.GetChildPrograms())
                    {
                        object childObject = childProgram.TrimControl;
                        if (childObject is inUC)
                        {
                            inUC childControl = childObject as inUC;
                            childControl.requestClose();
                        }
                    }
                }
                else if (receivedStr.StartsWith("actions:"))
                {
                    OmsControl.ShowActions(receivedStr.Substring(8));
                }
                else if (receivedStr.StartsWith("savesearch:"))
                {
                    OmsControl.SaveSeach(receivedStr.Substring(11));
                }
                else if (receivedStr.StartsWith("savedashboard:"))
                {
                    OmsControl.SaveInDashboard(receivedStr.Substring(14));
                }
            };
        }

        private void SmartPartClosingEventHandler(object sender, WorkspaceCancelEventArgs e)
        {
            // SCC has detected the user wants to close a control ...
            object o1 = e.SmartPart;
            if (o1 is IDialogView)
            {
                IDialogView OmsControl = o1 as DialogView;
                if (OmsControl.IsOKToClose())
                {
                    // backend has already confirmed it is OK to close, go on and close ...
                    e.Cancel = false;
                }
                else
                {
                    // do not close the control yet, backend has to confirm it is OK first
                    e.Cancel = true;
                    object o2 = OmsControl.TrimControl;
                    if (o2 is inUC)
                    {
                        inUC TrimControl = o2 as inUC;
                        TrimControl.requestClose();
                    }
                }
            }
        }

        private bool checkIfOkToCloseAllOmsPrograms()
        {
            bool isOK = true;
            foreach (IDialogView OmsControl in OpenTabs)
            {
                if (!OmsControl.IsOKToClose())
                {
                    isOK = false;
                    break;
                }
            }
            return isOK;
        }

        void MainWindow_Closing(object sender, System.ComponentModel.CancelEventArgs e)
        {
            if (OpenTabs.Count > 0)
            {
                foreach (IDialogView OmsControl in OpenTabs)
                {
                    object o2 = OmsControl.TrimControl;
                    if (o2 is inUC)
                    {
                        e.Cancel = true;
                        isWindowCloseRequested = true;
                        inUC TrimControl = o2 as inUC;
                        TrimControl.requestClose();
                    }
                }
            }
        }

        void SetProgramContextFrameInfo()
        {
            // show oms context info in bottom frame of SCC window

            ShellInteractionService.ContextInfo =
                      omsSessionContext.UserName + ",  " +
                      omsSessionContext.OMSLogicalUserId + ",  " +
                      omsSessionContext.SystemName + "  ";
        }

        public string Id
        {
            get
            {
                return ModuleId;
            }
        }

        public ImageSource Icon
        {
            get
            {
                return OrderManagementIcon.ImageSource;
            }
        }

        public string Title
        {
            get
            {
                return Resources.ApplicationName_text;
            }
        }

        public string Version
        {
            get
            {
                return Resources.ApplicationVersion_text;
            }
        }

        public int OrderIndex
        {
            get { return 1; }
            set { }
        }

        public XmlDocument GetMenu()
        {
            XmlDocument menu = new XmlDocument(); ;
            // let user choose logical OMS user
            try
            {
                if (omsSessionContext.ClientProgram == null)  // dashboard compliance
                {
                    EventTopic userSettingsTopic = WorkItem.EventTopics.Get(Imi.SupplyChain.UX.Modules.OrderManagement.Views.Constants.EventTopicNames.ShowChooseUserDialog);
                    userSettingsTopic.Fire(this, new EventArgs(), WorkItem, PublicationScope.Global);
                }
            }
            catch (EventTopicException ex)
            {
                string message = "";
                if (ex.Exceptions.Count > 0)
                {
                    message = ex.Exceptions[0].Message;
                }

                ShellInteractionService.ShowMessageBox(Resources.ChooseOMSUserException_text,
                    message, null, Infrastructure.MessageBoxButton.Ok, Infrastructure.MessageBoxImage.Error);
                XmlElement root = menu.CreateElement("folder");
                root.SetAttribute("caption", "");
                menu.AppendChild(root);
                return menu;
            }
            catch (Exception ex)
            {
                ShellInteractionService.ShowMessageBox(Resources.ChooseOMSUserException_text,
                    ex.Message, null, Infrastructure.MessageBoxButton.Ok, Infrastructure.MessageBoxImage.Error);
                XmlElement root = menu.CreateElement("folder");
                root.SetAttribute("caption", "");
                menu.AppendChild(root);
                return menu;
            }

            try
            {
                menu = omsWebServiceWrapper.GetMenu();
            }
            catch (Exception ex)
            {
                menu = new XmlDocument();
                XmlElement root = menu.CreateElement("folder");
                root.SetAttribute("caption", "");
                menu.AppendChild(root);

                ShellInteractionService.ShowMessageBox(Resources.LoadMenuException_text,
                    ex.Message, null, Infrastructure.MessageBoxButton.Ok, Infrastructure.MessageBoxImage.Error);
            }

            //Debug.WriteLine(menu.OuterXml);
            return menu;
        }

        public bool IsDefault
        {
            get
            {
                return false;
            }
        }

        private string createStartOmsProgramXml(string orderProgram, string extraParam)
        {
            StringBuilder builder = new StringBuilder("<DV><INI auto_start=");
            builder.Append(omsSessionContext.AutoStart == "1" ? "'yes'" : "'no'");
            builder.Append(" hostname='");
            builder.Append(configSection.HostName);
            builder.Append("' port='");
            builder.Append(configSection.HostPort);
            builder.Append("' program='");
            builder.Append(omsSessionContext.ServerProgram);
            if (omsSessionContext.DecimalKey != null)
            {
                builder.Append("' decimal_key='");
                builder.Append(omsSessionContext.DecimalKey);
            }
            if (omsSessionContext.EnvironmentVariables != null)
            {
                builder.Append("' env_vars='");
                builder.Append(omsSessionContext.EnvironmentVariables);
                builder.Append(",CLIENTPC_NAME=" + System.Environment.MachineName);
            }
            builder.Append("' parameters='");
            builder.Append(prepareParametersString(omsSessionContext.Parameters, orderProgram, extraParam));
            builder.Append("' working_directory='");
            builder.Append(omsSessionContext.ServerWorkingDirectory);
            builder.Append("'/><USER UID='");
            if (configSection.SendDomainUserId)
                builder.Append(UserSessionService.DomainUser);
            else
                builder.Append(UserSessionService.UserId);

            string verificationStr;
            if (configSection.SendSecurityToken)
                verificationStr = getSecurityToken().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("\"", "&quot;").Replace("'", "&apos;");
            else
                verificationStr = "IE9089ie8eoaa44AoeqQ";
            builder.Append("' PWD='" + verificationStr + "'/> </DV>");

            return builder.ToString();
        }

        private string prepareParametersString(string str, string orderProgram, string extraParam)
        {
            int pos = str.IndexOf("%s");
            str = str.Insert(pos + 2, orderProgram);
            str = str.Remove(pos, 2);
            pos = str.IndexOf("%s", pos + 1 - 2);
            str = str.Insert(pos + 2, omsSessionContext.OMSLogicalUserId);
            str = str.Remove(pos, 2);
            pos = str.IndexOf("%s", pos + 1 - 2);
            if (extraParam == null)
                str = str.Insert(pos + 2, "&quot;&quot;");
            else
            {
                extraParam = @"""" + extraParam + @"""";
                str = str.Insert(pos + 2, extraParam);
            }
            str = str.Remove(pos, 2);
            return str;
        }

        private string createStartWorkbenchProgramXml(string receivedStr)
        {
            int pos1 = receivedStr.IndexOf(' ');
            int pos2 = receivedStr.IndexOf(' ', pos1 + 1);
            string programName = receivedStr.Substring(pos1 + 1, pos2 - pos1);
            string parameters = receivedStr.Substring(pos2 + 1, receivedStr.Length - pos2 - 1);

            string xmlString = createStartOmsProgramXml(programName, parameters);

            return xmlString;
        }

        private string getSecurityToken()
        {
            SecurityTokenCache tokenCache = WorkItem.RootWorkItem.Items.FindByType<SecurityTokenCache>().Last();
            DateTime validTo = tokenCache.Token.ValidTo.ToLocalTime();
            if (DateTime.Now.CompareTo(validTo) >= 0)
            {
                MessageBox.Show(Resources.LoginSessionExpired_text);
                throw new SecurityTokenExpiredException();
            }
            return tokenCache.GetTokenXmlAsString();
        }

    }
}
